use dataMgmt::dataset::ValidationSet;
use dataMgmt::message::Message;
use evo_sys;
use evo_sys::prog::prog::Program;
use params;
use rand;
use rand::Rng;
use std;
use std::fs::File;
use std::io::Write;
use super::{PutResult, PopStats, PopEval, Population};
use dataMgmt::message::EvalResult;
use experiments::config::Config;
use experiments::config::{MapConfig};




pub struct ResultMap{
    prog_map: [[Option<Program>; params::MAP_COLS]; params::MAP_ROWS],
//    select_cell_method: u8,
//    compare_prog_method: u8,
    config: MapConfig,
    sent_count: u64,
    recieved_count: u64,
    finished: bool,
}


impl Population for ResultMap {

    fn try_put(&mut self, new_entry: EvalResult) -> PutResult {
        self.recieved_count += 1;
        if self.recieved_count >= self.config.total_evals {self.finished=true;}

        let inds = &new_entry.map_location.unwrap();

        if !self.is_in_bounds(inds) {return PutResult::Failed}

        let new_fit = new_entry.genome.test_fit.unwrap();
        let old_fit = self.get_test_fit(inds);

        let result =
            if inds.0 >= params::MAP_ROWS || inds.1 >= params::MAP_COLS || new_fit < old_fit { PutResult::Failed }
            else if new_fit > old_fit { PutResult::Improvement }
            else if rand::thread_rng().gen_weighted_bool(params::REPLACE_EQ_FIT) { PutResult::Equal }
            else { PutResult::Failed }; //eq but not replaced

        match result {
            PutResult::Failed => (),
            _ => self.put(new_entry, inds),
        }
        result
    }


    //pick random prog from map and return mutated copy
    fn get_simple_mutated_genome_rand(&self) -> Program {
        let mut tries = 0;
        let mut tr  = rand::thread_rng();

        while tries < params::MAP_COLS*params::MAP_ROWS * 1000 {
            if let Some(ref parent) = self.prog_map[tr.gen_range(0, params::MAP_ROWS)][tr.gen_range(0, params::MAP_COLS)] {
                return parent.test_mutate_copy()
            }
        }
        panic!("Timed out when trying to select a parent genome from results map!!");
    }


    fn update_cv(&mut self, data: &ValidationSet) {
        for row_i in 0.. params::MAP_ROWS{
            for col_i in 0.. params::MAP_COLS{
                if let Some(ref mut genome) = self.prog_map[row_i][ col_i] {
                    match genome.cv_fit {
                        Some(_) => (),
                        None => genome.cv_fit = Some(evo_sys::prog::eval::eval_program_cv(&genome, &data)),
                    }
                }
            }
        }
    }


    fn get_pop_stats(&self, eval: PopEval) -> PopStats {
        let mut best = std::f32::MIN;
        let mut worst = std::f32::MAX;
        let mut ave = 0.0f64;
        let mut count = 0.0;

        for row_i in 0.. params::MAP_ROWS{
            for col_i in 0.. params::MAP_COLS{

                if let Some(ref prog) = self.prog_map[row_i][ col_i]{
                    let value = match eval {
                        PopEval::TestFit => prog.test_fit.unwrap(),
                        PopEval::CV => prog.cv_fit.unwrap(),
                        PopEval::Geno(eval) => eval(prog),
                    };

                    ave += value as f64;
                    count += 1.0;
                    if value > best {best=value;}
                    if value < worst {worst=value;}
                }

            }
        }
        ave = ave/count;

        let mut vari = 0.0;
        for row_i in 0.. params::MAP_ROWS{
            for col_i in 0.. params::MAP_COLS{

                if let Some(ref prog) = self.prog_map[row_i][ col_i]{
                    let value = match eval {
                        PopEval::TestFit => prog.test_fit.unwrap(),
                        PopEval::CV => prog.cv_fit.unwrap(),
                        PopEval::Geno(eval) => eval(prog),
                    };
                    vari += (value as f64-ave).powi(2);
                }

            }
        }
        vari /= count;
        PopStats {best, worst, ave, sd:vari.sqrt(), count: count as f32}
    }


    fn write_pop_info(&self, file_name: &str, eval: PopEval) {
        let mut f = File::create(file_name).unwrap();

        for row_i in 0..params::MAP_ROWS {
            for col_i in 0..params::MAP_COLS {


                let value = if let Some(ref prog) = self.prog_map[row_i][ col_i]{
                    match eval {
                        PopEval::TestFit => prog.test_fit.unwrap(),
                        PopEval::CV => prog.cv_fit.unwrap(),
                        PopEval::Geno(eval) => eval(prog),
                    }

                }else {
                    params::MIN_FIT
                };

                f.write(value.to_string().as_bytes());
                f.write(b"\t");
            }
            f.write(b"\n");
        }
    }


    fn write_genos(&self, file_name: &str) {
        let mut f = File::create(file_name).unwrap();
        for row_i in 0..params::MAP_ROWS {
            for col_i in 0..params::MAP_COLS {
                if let Some(ref genome) = self.prog_map[row_i][ col_i] {
                    f.write(b"(");
                    f.write(row_i.to_string().as_bytes());
                    f.write(b",");
                    f.write(col_i.to_string().as_bytes());
                    f.write(b")");
                    f.write(b"\n");
                    genome.write_effective_self_words(&mut f);
                }
            }
        }
    }
}



impl ResultMap {

    pub fn is_finished(&self) -> bool{
        self.finished
    }


    pub fn get_new_prog(&mut self) -> Program{
        self.sent_count += 1;
        if self.sent_count <= self.config.initial_pop as u64{
            Program::new_default_range()
        }
        else {
            self.get_simple_mutated_genome_rand()
        }
    }


    pub fn pending_evals(&self)-> u64{
        self.sent_count - self.recieved_count
    }

    pub fn is_empty(&self)-> bool{
        self.recieved_count == 0
    }


    pub fn can_send(&self)->bool{
        if !self.pending_evals() < params::THREAD_POOL_MAX{
            return false;
        }
        (self.recieved_count > 0) || (self.sent_count < self.config.initial_pop as u64)
    }

    fn get_test_fit(&self, inds: &(usize, usize)) -> f32 {
        match self.prog_map[inds.0][inds.1] {
            Some(ref prog) => prog.test_fit.unwrap(),
            None => params::MIN_FIT,
        }
    }

    fn get_cv_fit(&self, inds: &(usize, usize)) -> f32 {
        match self.prog_map[inds.0][inds.1] {
            Some(ref prog) => prog.cv_fit.unwrap(),
            None => params::MIN_FIT,
        }
    }

    fn put(&mut self, val: EvalResult, inds: &(usize, usize)) {
        self.prog_map[inds.0][inds.1] = Some(val.genome);
    }

    fn is_in_bounds(&self, inds: &(usize, usize))-> bool{
        (inds.0 < params::MAP_ROWS) && (inds.1 < params::MAP_COLS)
    }

}


impl ResultMap {
    pub fn new( config: MapConfig) -> ResultMap {
        ResultMap {
            prog_map:
            [[None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None],
                [None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None], ],
//            select_cell_method,
//            compare_prog_method,
            config,
            sent_count: 0,
            recieved_count: 0,
            finished: false,
        }
    }
}